--[[
    NOGRUS HUB - UNBOXING SIMULATOR
    VERSION: 1.0 (Public Release)
]]

-- 1. TOGGLE BUTTON
pcall(function() game.CoreGui:FindFirstChild("NogrusHub_Toggle"):Destroy() end)
local ToggleGui = Instance.new("ScreenGui")
ToggleGui.Name = "NogrusHub_Toggle"
ToggleGui.Parent = game:GetService("CoreGui")

local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Parent = ToggleGui
ToggleBtn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
ToggleBtn.Position = UDim2.new(0.5, -50, 0, 5)
ToggleBtn.Size = UDim2.new(0, 100, 0, 30)
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.Text = "TOGGLE UI"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 12
ToggleBtn.AutoButtonColor = true
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 6)
Instance.new("UIStroke", ToggleBtn).Color = Color3.fromRGB(60, 60, 60)

local VirtualInputManager = game:GetService("VirtualInputManager")
ToggleBtn.MouseButton1Click:Connect(function()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.LeftControl, false, game)
    task.wait()
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.LeftControl, false, game)
end)

-- ============================================================================
-- MAIN SCRIPT
-- ============================================================================

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

local RF = ReplicatedStorage:FindFirstChild("RF")
local RE = ReplicatedStorage:FindFirstChild("RE")

local ItemListModule = require(ReplicatedStorage.Shared.ItemList)
local ReplicaModule = require(ReplicatedStorage.Modules.Replica)
local ItemDataModule = require(ReplicatedStorage.Shared.ItemData)
local GameItemsModule = require(ReplicatedStorage.Shared.GameData.Items)

-- CONFIGS
getgenv().FarmEnabled = false
getgenv().AutoEquipEnabled = false
getgenv().AutoEquipPets = false
getgenv().AutoSellEnabled = false
getgenv().QuestEnabled = false
getgenv().AnimKiller = true
getgenv().ShowVisual = true

getgenv().FarmRadius = 60
getgenv().FarmMode = "AURA" 
getgenv().FarmLock = false 
getgenv().FarmCenter = nil 

-- OFFICIAL RARITY LIST
local OfficialRarities = {"Common", "Rare", "Epic", "Legendary", "Godly", "Mythic", "Ethereal", "Celestial"}
local RarityMap = {["Common"]=1, ["Rare"]=2, ["Epic"]=3, ["Legendary"]=4, ["Godly"]=5, ["Mythic"]=6, ["Ethereal"]=7, ["Celestial"]=8}

getgenv().SellConfig = {}
for _, r in pairs(OfficialRarities) do getgenv().SellConfig[RarityMap[r]] = false end

-- CONFIGS WEBHOOK
getgenv().WebhookUrl = ""
getgenv().WebhookEnabled = false
getgenv().WebhookPing = false
getgenv().WebhookRarities = {} 

local AlvoAtual = nil
local KnownItems = {} 

-- UI WINDOW
local Window = Fluent:CreateWindow({
    Title = "Nogrus Hub",
    SubTitle = "v1.0",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl 
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "home" }),
    Items = Window:AddTab({ Title = "Items", Icon = "backpack" }),
    Webhook = Window:AddTab({ Title = "Webhook", Icon = "globe" }),
    Misc = Window:AddTab({ Title = "Misc", Icon = "component" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

local Options = Fluent.Options

-- ============================================================================
-- MAIN TAB (FARM)
-- ============================================================================

local FarmToggle = Tabs.Main:AddToggle("FarmEnabled", {Title = "Auto Farm (Beta)", Default = false })
FarmToggle:OnChanged(function()
    getgenv().FarmEnabled = Options.FarmEnabled.Value
    if not getgenv().FarmEnabled then
        AlvoAtual = nil
        Mouse.TargetFilter = nil
    end
end)

Tabs.Main:AddDropdown("FarmMode", {
    Title = "Attack Mode",
    Values = {"AURA", "SQUARE"},
    Multi = false,
    Default = 1,
    Callback = function(Value)
        getgenv().FarmMode = Value
        if Value == "SQUARE" and not getgenv().FarmLock then
            getgenv().FarmCenter = nil
        end
    end
})

Tabs.Main:AddToggle("LockSquare", {
    Title = "Lock Position (Square)",
    Description = "ON: Fix Area | OFF: Follow Player",
    Default = false,
    Callback = function(Value)
        getgenv().FarmLock = Value
        if Value then
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                getgenv().FarmCenter = LocalPlayer.Character.HumanoidRootPart.Position
                Fluent:Notify({Title = "Locked", Content = "Farm position set.", Duration = 3})
            end
        else
            getgenv().FarmCenter = nil
            Fluent:Notify({Title = "Unlocked", Content = "Following player.", Duration = 3})
        end
    end
})

Tabs.Main:AddSlider("FarmRadius", {
    Title = "Farm Radius",
    Default = 60, Min = 10, Max = 200, Rounding = 1,
    Callback = function(v) getgenv().FarmRadius = v end
})

Tabs.Main:AddToggle("ShowVisual", {Title = "Show Visuals", Default = true, Callback = function(v) getgenv().ShowVisual = v end})
Tabs.Main:AddToggle("AnimKiller", {Title = "Fast Kill (Remove Anim)", Default = true, Callback = function(v) getgenv().AnimKiller = v end})

-- ============================================================================
-- ITEMS TAB (EQUIP ALL)
-- ============================================================================

Tabs.Items:AddToggle("AutoEquipEnabled", {
    Title = "Equip All Best Hats", 
    Default = false, 
    Callback = function(v) getgenv().AutoEquipEnabled = v end
})

Tabs.Items:AddToggle("AutoEquipPets", {
    Title = "Equip All Best Pets", 
    Default = false, 
    Callback = function(v) getgenv().AutoEquipPets = v end
})

-- ============================================================================
-- WEBHOOK TAB
-- ============================================================================

Tabs.Webhook:AddInput("WebhookUrl", {
    Title = "Discord Webhook URL",
    Default = "",
    Placeholder = "https://discord.com/api/webhooks/...",
    Callback = function(Value) getgenv().WebhookUrl = Value end
})

Tabs.Webhook:AddToggle("WebhookEnabled", {
    Title = "Enable Notifications",
    Default = false,
    Callback = function(Value)
        getgenv().WebhookEnabled = Value
        if Value then
             pcall(function()
                local PlayerReplica = nil
                for _, rep in pairs(ReplicaModule.GetReplicasByClass("PlayerData")) do if rep.Tags.Player == LocalPlayer then PlayerReplica = rep break end end
                if PlayerReplica and PlayerReplica.Data.Hats then
                    for id, _ in pairs(PlayerReplica.Data.Hats) do KnownItems[id] = true end
                end
            end)
            Fluent:Notify({Title = "Webhook", Content = "Monitoring drops...", Duration = 3})
        end
    end
})

Tabs.Webhook:AddToggle("WebhookPing", {
    Title = "Ping @everyone",
    Default = false,
    Callback = function(Value) getgenv().WebhookPing = Value end
})

local WhDropdown = Tabs.Webhook:AddDropdown("WebhookRarities", {
    Title = "Rarity Filter",
    Values = OfficialRarities,
    Multi = true,
    Default = {"Godly", "Mythic", "Ethereal", "Celestial"},
})

WhDropdown:OnChanged(function(Value)
    getgenv().WebhookRarities = {}
    for key, val in pairs(Value) do
        if val then getgenv().WebhookRarities[key] = true end
    end
end)

Tabs.Webhook:AddButton({
    Title = "Test Webhook",
    Callback = function()
        if getgenv().WebhookUrl == "" then 
            Fluent:Notify({Title = "Error", Content = "Set URL first!", Duration = 3})
        else
            local request = http_request or request or HttpPost or syn.request
            if request then
                request({
                    Url = getgenv().WebhookUrl,
                    Body = HttpService:JSONEncode({["content"] = "Webhook Test - Nogrus Hub ðŸ“¦"}),
                    Method = "POST",
                    Headers = {["content-type"] = "application/json"}
                })
                Fluent:Notify({Title = "Success", Content = "Test sent.", Duration = 3})
            end
        end
    end
})

-- ============================================================================
-- MISC TAB
-- ============================================================================

Tabs.Misc:AddToggle("AutoSellEnabled", {Title = "Auto Sell", Default = false, Callback = function(v) getgenv().AutoSellEnabled = v end})

local SellDropdown = Tabs.Misc:AddDropdown("SellConfig", { 
    Title = "Sell Rarities", 
    Values = OfficialRarities, 
    Multi = true, 
    Default = {} 
})

SellDropdown:OnChanged(function(Value)
    for _, id in pairs(RarityMap) do getgenv().SellConfig[id] = false end
    for key, val in pairs(Value) do 
        if val and RarityMap[key] then getgenv().SellConfig[RarityMap[key]] = true end
    end
end)

Tabs.Misc:AddToggle("QuestEnabled", {Title = "Auto Quests", Default = false, Callback = function(v) getgenv().QuestEnabled = v end})
Tabs.Misc:AddToggle("AntiAFKEnabled", {Title = "Anti-AFK", Default = true, Callback = function(v) getgenv().AntiAFKEnabled = v end})

-- ============================================================================
-- FARM LOGIC
-- ============================================================================

local VisualPart = Instance.new("Part"); VisualPart.Name = "NogrusFarmZone"; VisualPart.Shape = Enum.PartType.Block; VisualPart.Material = Enum.Material.Neon; VisualPart.Color = Color3.fromRGB(255, 50, 50); VisualPart.Transparency = 1; VisualPart.Anchored = true; VisualPart.CanCollide = false; pcall(function() VisualPart.Parent = Workspace end)

RunService.RenderStepped:Connect(function()
    pcall(function()
        if not getgenv().ShowVisual then VisualPart.Transparency = 1 return end
        if getgenv().FarmMode == "AURA" then VisualPart.Transparency = 1 return end 
        
        local CenterPos = nil
        local Color = Color3.fromRGB(0, 255, 150)

        if getgenv().FarmLock then
            CenterPos = getgenv().FarmCenter
            Color = Color3.fromRGB(255, 50, 50)
        else
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                CenterPos = LocalPlayer.Character.HumanoidRootPart.Position
            end
        end
        
        if CenterPos then 
            VisualPart.Transparency = 0.85; VisualPart.Color = Color
            VisualPart.Position = CenterPos - Vector3.new(0, 3, 0)
            local R = getgenv().FarmRadius or 60
            VisualPart.Size = Vector3.new(R*2, 0.2, R*2) 
        else VisualPart.Transparency = 1 end
    end)
end)

local DISTANCIA_PARADA = 7
local PalavrasChave = {"Box", "Chest", "Crate", "Gift", "Present", "Coin", "Gem"}

local function EhAlvo(obj)
    if obj.Name == "" and obj:IsA("Model") and obj:FindFirstChildWhichIsA("BasePart") then return true end
    if not obj or not obj:IsA("Model") or not obj:FindFirstChildWhichIsA("BasePart") then return false end
    local nl = obj.Name:lower()
    for _, k in pairs(PalavrasChave) do if nl:match(k:lower()) then return true end end
    return false
end

local function IsInArea(pos)
    if getgenv().FarmMode == "AURA" then return true end
    local Centro = nil
    if getgenv().FarmLock then Centro = getgenv().FarmCenter
    elseif LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then Centro = LocalPlayer.Character.HumanoidRootPart.Position end
    if not Centro then return false end
    local R = tonumber(getgenv().FarmRadius) or 60
    return (math.abs(pos.X - Centro.X) <= R and math.abs(pos.Z - Centro.Z) <= R)
end

local function BuscarTudo()
    local Root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart"); if not Root then return nil end
    local Candidatos = {}; 
    local function Explorar(pasta, prof) 
        if prof > 6 then return end
        for _, filho in pairs(pasta:GetChildren()) do 
            if EhAlvo(filho) then 
                local p = filho.PrimaryPart or filho:FindFirstChildWhichIsA("BasePart")
                if p then
                    if getgenv().ShowVisual then p.Color = Color3.new(1,1,1) end 
                    if IsInArea(p.Position) then
                        if getgenv().ShowVisual and getgenv().FarmMode == "SQUARE" then p.Color = Color3.fromRGB(170, 0, 255) end
                        table.insert(Candidatos, {Part = p, Dist = (Root.Position - p.Position).Magnitude}) 
                    end
                end
            elseif (filho:IsA("Folder") or filho:IsA("Model")) and filho.Name ~= "Pets" and filho.Name ~= "Lobby" then 
                Explorar(filho, prof + 1) 
            end 
        end 
    end
    pcall(function() for _, item in pairs(Workspace:GetChildren()) do if (item:IsA("Folder") or item:IsA("Model")) then Explorar(item, 1) end end end)
    table.sort(Candidatos, function(a,b) return a.Dist < b.Dist end); return Candidatos[1] and Candidatos[1].Part or nil
end

RunService.RenderStepped:Connect(function()
    pcall(function()
        if getgenv().FarmEnabled and LocalPlayer.Character then
            local Hum, Root = LocalPlayer.Character:FindFirstChild("Humanoid"), LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if Hum and Root and Hum.Health > 0 then
                if AlvoAtual and not AlvoAtual.Parent then AlvoAtual = nil end
                if not AlvoAtual then AlvoAtual = BuscarTudo() end
                if AlvoAtual then
                    local Dist = (Root.Position - AlvoAtual.Position).Magnitude
                    if Dist > DISTANCIA_PARADA then 
                        Hum:MoveTo(AlvoAtual.Position)
                    else 
                        Mouse.TargetFilter = LocalPlayer.Character
                        Camera.CFrame = CFrame.new(Camera.CFrame.Position, AlvoAtual.Position)
                        local ScreenPos, OnScreen = Camera:WorldToViewportPoint(AlvoAtual.Position)
                        if OnScreen then
                            VirtualInputManager:SendMouseButtonEvent(ScreenPos.X, ScreenPos.Y, 0, true, game, 1)
                            VirtualInputManager:SendMouseButtonEvent(ScreenPos.X, ScreenPos.Y, 0, false, game, 1)
                        end
                    end 
                end
            end
        else AlvoAtual = nil; Mouse.TargetFilter = nil end
    end)
end)

-- ============================================================================
-- WEBHOOK
-- ============================================================================

local function SendWebhook(itemName, rarity)
    if getgenv().WebhookUrl == "" then return end
    local content = ""; if getgenv().WebhookPing then content = "@everyone" end
    local color = 16777215
    if rarity == "Rare" then color = 3447003 elseif rarity == "Epic" then color = 10181046 elseif rarity == "Legendary" then color = 15105570 elseif rarity == "Godly" then color = 15548997 elseif rarity == "Mythic" then color = 15844367 elseif rarity == "Ethereal" then color = 1752220 elseif rarity == "Celestial" then color = 3066993 end
    local request = http_request or request or HttpPost or syn.request
    if request then request({Url = getgenv().WebhookUrl, Body = HttpService:JSONEncode({["content"] = content, ["username"] = "Nogrus Hub", ["embeds"] = {{["title"] = "ðŸ“¦ New Item Dropped!", ["description"] = "**Item:** " .. itemName .. "\n**Rarity:** " .. rarity, ["color"] = color, ["footer"] = {["text"]="Nogrus Hub"}, ["timestamp"]=os.date("!%Y-%m-%dT%H:%M:%SZ")}}}), Method = "POST", Headers = {["content-type"] = "application/json"}}) end
end

task.spawn(function()
    while true do task.wait(2)
        if getgenv().WebhookEnabled then
            pcall(function()
                local PlayerReplica = nil
                for _, rep in pairs(ReplicaModule.GetReplicasByClass("PlayerData")) do 
                    if rep.Tags.Player == LocalPlayer then PlayerReplica = rep break end 
                end
                
                if PlayerReplica and PlayerReplica.Data.Hats then
                    for id, hat in pairs(PlayerReplica.Data.Hats) do
                        if not KnownItems[id] then
                            KnownItems[id] = true
                            local Info = ItemDataModule.Get(hat.ItemId)
                            if Info then
                                local RarityID = Info.Rarity or 1
                                local RarityName = "Common"
                                for name, mapId in pairs(RarityMap) do
                                    if mapId == RarityID then RarityName = name break end
                                end
                                local Name = Info.DisplayName or Info.Name or "Item"
                                if getgenv().WebhookRarities[RarityName] then
                                    SendWebhook(Name, RarityName)
                                end
                            end
                        end
                    end
                end
            end)
        end
    end
end)

-- ============================================================================
-- AUTO EQUIP (FULL LIST SEND - HATS & PETS)
-- ============================================================================

-- [HATS]
task.spawn(function()
    while true do task.wait(5)
        if getgenv().AutoEquipEnabled then
            pcall(function()
                local PlayerReplica = nil
                for _, rep in pairs(ReplicaModule.GetReplicasByClass("PlayerData")) do if rep.Tags.Player == LocalPlayer then PlayerReplica = rep break end end
                if PlayerReplica and PlayerReplica.Data.Hats then
                    local AllHats = {}
                    for id, hat in pairs(PlayerReplica.Data.Hats) do
                        local Info = ItemDataModule.Get(hat.ItemId)
                        if Info then
                            -- Prioridade Fixa: DANO (Melhor OpÃ§Ã£o)
                            local Val = (GameItemsModule.GetDamage(hat.Level, Info.Rarity) or 0)
                            table.insert(AllHats, {Id = id, Val = Val})
                        end
                    end
                    table.sort(AllHats, function(a,b) return a.Val > b.Val end)
                    
                    local BestIds = {}
                    for i=1, #AllHats do table.insert(BestIds, AllHats[i].Id) end
                    
                    if #BestIds > 0 then RE.EquipBest:FireServer("Hat", BestIds, {}) end
                end
            end)
        end
    end
end)

-- [PETS]
task.spawn(function()
    while true do task.wait(5)
        if getgenv().AutoEquipPets then
            pcall(function()
                local PlayerReplica = nil
                for _, rep in pairs(ReplicaModule.GetReplicasByClass("PlayerData")) do if rep.Tags.Player == LocalPlayer then PlayerReplica = rep break end end
                if PlayerReplica and PlayerReplica.Data.Pets then
                    local AllPets = {}
                    for id, pet in pairs(PlayerReplica.Data.Pets) do
                        local Info = ItemDataModule.Get(pet.ItemId)
                        if Info then
                            -- Prioridade Fixa: DANO
                            local Val = (GameItemsModule.GetDamage(pet.Level, Info.Rarity) or 0)
                            table.insert(AllPets, {Id = id, Val = Val})
                        end
                    end
                    table.sort(AllPets, function(a,b) return a.Val > b.Val end)
                    
                    local BestIds = {}
                    for i=1, #AllPets do table.insert(BestIds, AllPets[i].Id) end
                    
                    if #BestIds > 0 then RE.EquipBest:FireServer("Pet", BestIds, {}) end
                end
            end)
        end
    end
end)

task.spawn(function()
    while true do task.wait(5)
        if getgenv().AutoSellEnabled then
            pcall(function()
                local PlayerReplica = nil; for _, rep in pairs(ReplicaModule.GetReplicasByClass("PlayerData")) do if rep.Tags.Player == LocalPlayer then PlayerReplica = rep break end end
                if PlayerReplica and PlayerReplica.Data.Hats then
                    local ToSell = {}
                    for id, hat in pairs(PlayerReplica.Data.Hats) do
                        local Info = ItemDataModule.Get(hat.ItemId)
                        if Info and not hat.IsEquipped and not hat.Locked and getgenv().SellConfig[Info.Rarity] then table.insert(ToSell, tostring(id)) end
                    end
                    if #ToSell > 0 and RF:FindFirstChild("SellItems") then RF.SellItems:InvokeServer(ToSell, "Hats") end
                end
            end)
        end
    end
end)

task.spawn(function()
    while true do task.wait(5)
        if getgenv().QuestEnabled and RE then
            pcall(function()
                local PlayerReplica = nil; for _, rep in pairs(ReplicaModule.GetReplicasByClass("PlayerData")) do if rep.Tags.Player == LocalPlayer then PlayerReplica = rep break end end
                if PlayerReplica and PlayerReplica.Data then
                    if PlayerReplica.Data.Quests then for qName in pairs(PlayerReplica.Data.Quests) do RE.CollectQuest:FireServer(qName) end end
                    RE.ClaimBattlePass:FireServer(); RE.ClaimLoginReward:FireServer()
                end
            end)
        end
    end
end)

task.spawn(function() 
    pcall(function() 
        local function Kill(self) if getgenv().AnimKiller and self.Model then self.Model:Destroy() end end
        local BoxAnim = game.ReplicatedStorage.Modules.BoxAnimations:FindFirstChild("Box")
        local GiftAnim = game.ReplicatedStorage.Modules.BoxAnimations:FindFirstChild("Gift")
        local GhostAnim = game.ReplicatedStorage.Modules.BoxAnimations:FindFirstChild("Ghost")
        if BoxAnim then require(BoxAnim).Open = Kill end; if GiftAnim then require(GiftAnim).Open = Kill end; if GhostAnim then require(GhostAnim).Open = Kill end
    end) 
end)

LocalPlayer.Idled:Connect(function() if getgenv().AntiAFKEnabled then VirtualInputManager:SendKeyEvent(true, "Space", false, game) end end)

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:SetFolder("NogrusHub")
SaveManager:SetFolder("NogrusHub/Configs")
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

Window:SelectTab(1)
Fluent:Notify({Title = "Nogrus Hub", Content = "Script Loaded Successfully!", Duration = 5})
SaveManager:LoadAutoloadConfig()
